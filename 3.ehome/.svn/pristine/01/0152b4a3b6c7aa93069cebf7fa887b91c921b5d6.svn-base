/**
 * Copyright &copy; 2012-2014 <a href="https://its111.com">Its111</a> All rights reserved.
 */
package com.its.modules.village.service;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.its.common.persistence.Page;
import com.its.common.service.CrudService;
import com.its.common.utils.StringUtils;
import com.its.modules.module.entity.VillageLinerecombusitype;
import com.its.modules.module.entity.VillageLinerecommodule;
import com.its.modules.module.entity.VillageLinerecomspecial;
import com.its.modules.module.service.VillageLinerecombusitypeService;
import com.its.modules.module.service.VillageLinerecommoduleService;
import com.its.modules.module.service.VillageLinerecomspecialService;
import com.its.modules.village.dao.VillageLineDao;
import com.its.modules.village.entity.VillageLine;

/**
 * 楼盘信息产品线Service
 * 
 * @author ChenXiangyu
 * @version 2017-07-11
 */
@Service
@Transactional(readOnly = true)
public class VillageLineService extends CrudService<VillageLineDao, VillageLine> {

    @Autowired
    private VillageLineDao villageLineDao;
    @Autowired
    private VillageLinerecommoduleService recommoduleService;
    @Autowired
    private VillageLinerecomspecialService recomspecialService;
    @Autowired
    private VillageLinerecombusitypeService recomBusTypeService;

    public VillageLine get(String id) {
        return super.get(id);
    }

    public List<VillageLine> findList(VillageLine villageLine) {
        return super.findList(villageLine);
    }

    public Page<VillageLine> findPage(Page<VillageLine> page, VillageLine villageLine) {
        return super.findPage(page, villageLine);
    }

    @Transactional(readOnly = false)
    public void save(VillageLine villageLine) {
        super.save(villageLine);
    }

    @Transactional(readOnly = false)
    public void delete(VillageLine villageLine) {
        super.delete(villageLine);
    }

    /**
     * 根据楼盘ID获取所有楼盘产品线记录
     * 
     * @param villageLine
     * @return 所有楼盘产品线记录（包括被逻辑删除的）
     */
    public List<VillageLine> findListByVillageId(String villageInfoId) {
        VillageLine villageLine = new VillageLine();
        villageLine.setVillageInfoId(villageInfoId);
        List<VillageLine> villageLineList = villageLineDao.findListByVillageId(villageLine);
        return (villageLineList != null) ? villageLineList : new ArrayList<VillageLine>();
    }

    /**
     * 获取所有已设置模块的楼盘产品线信息
     * 
     * @return
     */
    public List<VillageLine> findSettedList() {
        List<VillageLine> villageLineList = villageLineDao.findSettedList();
        return (villageLineList != null) ? villageLineList : new ArrayList<VillageLine>();
    }

    /**
     * 获取楼盘线关联的的所有楼盘信息列表
     * 
     * @param page
     * @param entity
     * @return
     * @return Page<VillageLine>
     * @author zhujiao
     * @date 2017年7月24日 下午8:53:37
     */
    public Page<VillageLine> findLineList(Page<VillageLine> page, VillageLine entity) {
        entity.setPage(page);
        page.setList(villageLineDao.findLineList(entity));
        return page;
    }

    /**
     * 设置模块
     * 
     * @param page
     * @param entity
     * @return
     * @return Page<VillageLine>
     * @author zhujiao
     * @date 2017年7月25日 上午10:32:41
     */
    @Transactional(readOnly = false)
    public void setModule(VillageLine villageLine) {
        try{
        //添加排序的处理
        String community=StringUtils.strComparator(villageLine.getCommunityModule(), villageLine.getCommunityModuleSort());
        String life=StringUtils.strComparator(villageLine.getLifeModule(), villageLine.getLifeModuleSort());
        
        String[] arrCommunity=community.split("\\|");
        villageLine.setCommunityModule(arrCommunity[0]);
        villageLine.setCommunityModuleSort(arrCommunity[1]);
        
        String[] arrLife=life.split("\\|");
        villageLine.setLifeModule(arrLife[0]);
        villageLine.setLifeModuleSort(arrLife[1]);
        }catch(Exception e){
           System.out.println("重组模块失败："+e.getMessage());
        }
        
        villageLineDao.setModule(villageLine);
    }

    /**
     * 批量设置模块（根据楼盘信息设置模块数据）
     * 
     * @param page
     * @param entity
     * @return
     * @return Page<VillageLine>
     * @author zhujiao
     * @date 2017年7月25日 上午10:32:41
     */
    @Transactional(readOnly = false)
    public void batchSetModule(VillageLine villageLine) {
        //添加排序的处理
        String community=StringUtils.strComparator(villageLine.getCommunityModule(), villageLine.getCommunityModuleSort());
        String[] arrCommunity=community.split("\\|");
        villageLine.setCommunityModule(arrCommunity[0]);
        villageLine.setCommunityModuleSort(arrCommunity[1]);
        
        String life=StringUtils.strComparator(villageLine.getLifeModule(), villageLine.getLifeModuleSort());
        String[] arrLife=life.split("\\|");
        villageLine.setLifeModule(arrLife[0]);
        villageLine.setLifeModuleSort(arrLife[1]);
        //
        if (villageLine.getVillageIdList() != null) {
            for (int i = 0; i < villageLine.getVillageIdList().length; i++) {
                villageLine.setVillageInfoId(villageLine.getVillageIdList()[i]);
                villageLineDao.batchSetModule(villageLine);
            }
        }
    }

    /**
     * 推荐设置-设置首页推荐
     * 
     * @param villageLine
     * @return void
     * @author zhujiao
     * @date 2017年7月26日 上午11:19:11
     */
    @Transactional(readOnly = false)
    public void updateMaintRecomModule(VillageLine villageLine) {
        //添加排序的处理
        String maintRecomModule=StringUtils.strComparator(villageLine.getMaintRecomModule(), villageLine.getMaintRecomModuleSort());
        String[] arrMaintRecomModule=maintRecomModule.split("\\|");
        villageLine.setMaintRecomModule(arrMaintRecomModule[0]);
        villageLine.setMaintRecomModuleSort(arrMaintRecomModule[1]);
        
        villageLineDao.updateMaintRecomModule(villageLine);
    }

    /**
     * 推荐设置-设置社区推荐
     * 
     * @param villageLine
     * @return void
     * @author zhujiao
     * @date 2017年8月2日 下午7:02:48
     */
    @Transactional(readOnly = false)
    public void updateCommunityRecomModule(VillageLine villageLine) {
        //添加排序的处理
        String community=StringUtils.strComparator(villageLine.getCommunityRecomModule(), villageLine.getCommunityRecomModuleSort());
        String[] arrCommunity=community.split("\\|");
        villageLine.setCommunityRecomModule(arrCommunity[0]);
        villageLine.setCommunityRecomModuleSort(arrCommunity[1]);
        
        villageLineDao.updateCommunityRecomModule(villageLine);
    }

    /**
     * 推荐设置-设置优家推荐（模块）
     * 
     * @param villageLine
     * @return void
     * @author zhujiao
     * @date 2017年7月26日 上午11:25:46
     */
    @Transactional(readOnly = false)
    public void updateLifeRecomModule(VillageLine villageLine) {
        try {
            // 保存主表
            //添加排序的处理
            String life=StringUtils.strComparator(villageLine.getLifeRecomModule(), villageLine.getLifeRecomModuleSort());
            String[] arrLife=life.split("\\|");
            villageLine.setLifeRecomModule(arrLife[0]);
            villageLine.setLifeRecomModuleSort(arrLife[1]);
            villageLineDao.updateLifeRecomModule(villageLine);
            // 保存-修改-删除 推荐模块数据
            recommoduleService.saveRecomModule(villageLine);
            // 保存-修改-删除 推荐专题数据
            recomspecialService.saveSpecialModule(villageLine);
            //保存-修改-删除 推荐商家数据
            recomBusTypeService.saveBusTypeModule(villageLine);
        } catch (Exception e) {
            System.out.println("保存生活推荐异常：" + e.getMessage());
        }
    }

    /**
     * 获取楼盘产品线信息-
     * 
     * @param id
     * @return
     * @return VillageLine
     * @author zhujiao
     * @date 2017年7月27日 上午11:05:08
     */
    public VillageLine getModel(String id) {
        VillageLine model = villageLineDao.get(id);
        try {// 获取楼盘相关的推荐模块信息
            List<VillageLinerecommodule> recomModuleList = recommoduleService.getRecomModuleList(model.getId());
            model.setRecomModuleList(recomModuleList);
        } catch (Exception e) {
            System.out.println("获取推荐模块异常：" + e.getMessage());
        }
        try {// 获取楼盘相关的推荐专题信息
            List<VillageLinerecomspecial> recomSpecialList = recomspecialService.getRecomSpecialList(model.getId());
            model.setRecomSpecialList(recomSpecialList);
        } catch (Exception e) {
            System.out.println("获取推荐专题异常：" + e.getMessage());
        }
        try {// 获取楼盘相关的推荐商家类型信息
            List<VillageLinerecombusitype> recomBusType = recomBusTypeService.getRecomBusTypeList(model.getId());
            model.setRecomBusTypeList(recomBusType);
        } catch (Exception e) {
            System.out.println("获取推荐商家信息异常：" + e.getMessage());
        }
        return model;
    }

}
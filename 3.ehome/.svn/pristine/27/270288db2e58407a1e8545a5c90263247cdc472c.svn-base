var vm = new Vue({
	el: "#app",
	data: {
		urlList: {
			list: "commoditylist.html?id=",
			groupbuy: "../groupbuy/groupbuydetail.html?id=",
			phoneicon: "../../images/telphone.png",
			goicon: "../../images/grey_go.png"
		},
		order: {},
		timePeriod: [],
		deliveryDate: {
			label: "",
			date: "",
			desc: "",
			isImmediate: 1,
			start: "",
			end: ""
		},
		customer:{
		contactPerson:"",
		contactPhone:"",
		contactAddress:""	
		},
		item:{},		
		items2:[],
		totalMoney:0,
		coupons:{
		name:"不使用优惠券",
		money:0
    }
		,items3:[]
	},
	mounted: function() { //页面加载之后自动调用，常用于页面渲染
		this.$nextTick(function() { //在2.0版本中，加mounted的$nextTick方法，才能使用vm
			this.cartView();
		})
	},
	methods: {
		// 渲染页面
		cartView: function() {
			var _this = this;
				this.$http("../../data/person.json").then(function(res){
                  _this.items2 = res.data.data; });
            this.$http("../../data/cou.json").then(function(res){
                  _this.items3 = res.data.data; });
			this.$http.get(interfaceUrl + "/live/confirmBusinessOrder", {
				userID: userInfo.userID,
				buildingID: userInfo.buildingID,
				businessID: getQueryString("id")
			}).then(function(res){
				_this.order = res.data.data;  
	                _this.customer.contactPerson=res.data.data.contactPerson;
	                _this.customer.contactPhone=res.data.data.contactPhone;
	                _this.customer.contactAddress=res.data.data.contactAddress;
					_this.totalMoney=res.data.data.totalMoney;
				if (res.data.data.deliveryDate && res.data.data.deliveryDate.length > 0) {
					var delivery = res.data.data.deliveryDate[0];
					var delivery2 = res.data.data.deliveryDate[1];
					_this.deliveryDate.date = delivery.date;
					_this.deliveryDate.date = delivery2.date;
					if (delivery.timePeriod && delivery.timePeriod.length > 0) {
						_this.deliveryDate.isImmediate = delivery.timePeriod[0].isImmediate;
						_this.deliveryDate.start = delivery.timePeriod[0].start;
						_this.deliveryDate.end = delivery.timePeriod[0].end;

						if (delivery.timePeriod[0].isImmediate == 1) {
							_this.deliveryDate.label = "立即配送（预计" + delivery.timePeriod[0].end + "送达）";
						} else {
							_this.deliveryDate.label = "预计" + delivery.desc + " " + delivery.timePeriod[0].start + '~' + delivery.timePeriod[0].end + "送达";
						}
					} else {
						_this.deliveryDate.isImmediate = delivery2.timePeriod[0].isImmediate;
						_this.deliveryDate.start = delivery2.timePeriod[0].start;
						_this.deliveryDate.end = delivery2.timePeriod[0].end;

						if (delivery2.timePeriod[0].isImmediate == 1) {
							_this.deliveryDate.label = "立即配送（预计" + delivery2.desc + delivery2.timePeriod[0].end + "送达）";
						} else {
							_this.deliveryDate.label = "预计" + delivery2.desc + " " + delivery2.timePeriod[0].start + '~' + delivery2.timePeriod[0].end + "送达";
						}
					}
				}
				_this.timePeriod = res.data.data.deliveryDate[0].timePeriod;
			})
		 $(".details_spgm_right_2 > img").attr("src","../../images/01.png");			
			
		},
		changeDelivery: function(delivery) {
			$("#timeModal .business_mainmenu2 li.selected").removeClass("selected");
			$(event.target).closest("li").addClass("selected");
			this.timePeriod = delivery.timePeriod;
			this.deliveryDate.date = delivery.date;
			this.deliveryDate.desc = delivery.desc;
		},
		timeSelected: function(period) {
			this.deliveryDate.isImmediate = period.isImmediate;
			this.deliveryDate.start = period.start;
			this.deliveryDate.end = period.end;
			if (period.isImmediate == 1) {
				this.deliveryDate.label = "立即配送（预计" + period.end + "送达）";
			} else {
				this.deliveryDate.label = "预计" + this.deliveryDate.desc + " " + period.start + '~' + period.end + "送达";
			}

			$("#timeModal").modal('toggle');
		},
		submitOrder: function() {
			var _this = this;
			this.$http.post(interfaceUrl + "/live/submitBusinessOrder", {
				userID: userInfo.userID,
				buildingID: userInfo.buildingID,
				businessID: getQueryString("id"),
				contactPerson: _this.order.contactPerson,
				contactPhone: _this.order.contactPhone,
				contactAddress: _this.order.contactAddress,
				isImmediate: 0,
				deliveryStart: _this.deliveryDate.data + _this.deliveryDate.start,
				deliveryEnd: _this.deliveryDate.data + _this.deliveryDate.end,
				leaveMessage: ""
			}, {
				emulateJSON: true
			}).then(function(res) {
				if (res.data.code == 1000) {
					_this.item = res.data.data;

				} else if (res.data.code == 5000) {
					layer.open({
						content: res.data.message,
						btn: '确定',
						shadeClose: false,
					});
				}
			})
		 }
			
	
			,changeStatusAddress(item){
			$(event.target).attr("src","../../images/01.png").parents("#place1_ad").siblings().find("#img").attr("src","../../images/02.png");
			this.customer.contactPerson=item.name;
			this.customer.contactPhone=item.phone;
			this.customer.contactAddress=item.place;
			
			$("#myModal_address").modal('toggle');
			
		}
	     ,changeStatusCoupons1:function(){
             $(".choose_coup_main_right > span > img").attr("src","../../images/02.png");				     	
			$(event.target).attr("src","../../images/01.png");			
			$("#couponModal").modal('toggle');
	     }
	,changeStatusCoupons2:function(item){
		 $(".details_spgm_right_2 > img").attr("src","../../images/02.png");			
			$(event.target).attr("src","../../images/01.png").parents(".choose_coup_main").siblings().find(".choose_coup_main_right > span > img").attr("src","../../images/02.png");		
			this.coupons.name=item.couponMoney;
			this.coupons.money=item.couponMoney;
			this.calcMonery();
			$("#couponModal").modal('toggle');		
	},
	calcMonery(){
		var m=this.order.totalMoney;
		var d=this.order.deliveryFee;
		var a=this.order.activityDiscounted;
		
		this.totalMoney=m+d-this.coupons.money-a;
		
		
	}
}
	})
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
	
	


package com.its.modules.app.web;

import java.io.BufferedOutputStream;
import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.SortedMap;
import java.util.TreeMap;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import com.its.common.web.BaseController;
import com.its.modules.app.common.payUtil.wechatpay.XMLUtilJdom;
import com.its.modules.app.service.OrderPayService;

/**
 * 订单支付Controller
 * 
 * @author sushipeng
 * 
 * @version 2017-08-08
 */
@Controller
@RequestMapping(value = "${appPath}/live")
public class OrderPayController extends BaseController {

	@Autowired
	private OrderPayService orderPayService;

	/**
	 * 微信支付成功通知（回调接口）
	 */
	@RequestMapping(value = "wechartOrderNotify", method = RequestMethod.POST)
	@ResponseBody
	public void wechartOrderNotify(HttpServletRequest request, HttpServletResponse response) throws Exception {
		// 解析Request获取XML字符串
		logger.warn("微信支付回调接口==========>开始解析Request");
		InputStream inputStream = request.getInputStream();
		StringBuffer xmlStr = new StringBuffer();
		String line;
		BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream, "UTF-8"));
		while ((line = reader.readLine()) != null) {
			xmlStr.append(line);
		}
		reader.close();
		inputStream.close();
		logger.warn("微信支付回调接口XML文件==========>" + xmlStr);

		// 解析XML成Map
		Map<String, String> map = new HashMap<String, String>();
		map = XMLUtilJdom.doXMLParse(xmlStr.toString());
		// 过滤VALUE中的空格
		SortedMap<String, String> packageParams = new TreeMap<String, String>();
		Iterator<String> it = map.keySet().iterator();
		while (it.hasNext()) {
			String key = it.next();
			String parameterValue = map.get(key);
			String value = "";
			if (null != parameterValue) {
				value = parameterValue.trim();
			}
			packageParams.put(key, value);
		}
		logger.warn("packageParams==========>" + packageParams.toString());

		// 执行业务逻辑
		BufferedOutputStream out = new BufferedOutputStream(response.getOutputStream());
		out.write(orderPayService.wechatNotify(packageParams).getBytes());
		out.flush();
		out.close();
	}

	/**
	 * 支付宝支付成功通知（回调接口）
	 */
	@SuppressWarnings("unchecked")
	@RequestMapping(value = "alipayOrderNotify", method = RequestMethod.POST)
	@ResponseBody
	public String alipayOrderNotify(HttpServletRequest request, HttpServletResponse response) {
		// 获取支付宝POST过来的反馈信息
		logger.warn("支付宝支付回调接口==========>开始解析Request");
		Map<String, String> params = new HashMap<String, String>();
		Map<String, String[]> requestParams = request.getParameterMap();
		Iterator<String> it = requestParams.keySet().iterator();
		while (it.hasNext()) {
			String key = it.next();
			String[] values = requestParams.get(key);
			String value = "";
			for (int i = 0; i < values.length; i++) {
				value = (i == values.length - 1) ? value + values[i] : value + values[i] + ",";
			}
			params.put(key, value);
		}
		logger.warn("params==========>" + params.toString());

		// 执行业务逻辑
		return orderPayService.alipayNotify(request, params);
	}
}